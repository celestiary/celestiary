<!DOCTYPE html>
<html>
<head><link rel="stylesheet" href="index.css"/></head>
<body>
<div id="ui"></div>
<h1>Orbit</h1>
An example orbit.  <a href="https://en.wikipedia.org/wiki/Orbital_elements">
  https://en.wikipedia.org/wiki/Orbital_elements</a>
<image style="width: 400px" src="images/Orbit1.png"
       alt="By Lasunncty at the English Wikipedia, CC BY-SA 3.0, https://commons.wikimedia.org/w/index.php?curid=8971052"/>

<table style="width: 600px"><tr><td style="width: 20%; vertical-align: top"><tr><td>
  <table id="faves"></table>
</td><td style="width: 80%">
  <form name="elts"><table id="propsTable"></table></form>
</td></tr></table>
<em style="font-size: small">(or change hash to <a href="#test">#test</a> and reload)</em>
<script type="module">
  import * as THREE from './js/lib/three.js/three.module.js';
  import Fullscreen from './js/fullscreen.js';
  import Label from './js/label.js';
  import Orbit from './js/Orbit.js';
  import ThreeUi from './js/three_ui.js';
  import {angle, arrow, grid, line, solidEllipse} from './js/shapes.js';
  import {addAndOrient, planetHelper} from './js/scene_utils.js';
  import {visitFilterProperty} from './js/utils.js';

  const ui = new ThreeUi('ui');
  ui.camera.position.set(1, 1, 3);
//ui.scene.add(grid({color: 0x0000ff, opacity: 0.3}));
  ui.scene.add(new THREE.AmbientLight());

  function setupProps(orbitProps) {
    const tau = Math.PI * 2;
    const tauInDeg = 360;
    const elementMaxes = {
      siderealOrbitPeriod: 7.8184256184e9,
      eccentricity: 1,
      inclination: tauInDeg,
      longitudeOfAscendingNode: tauInDeg,
      longitudeOfPericenter: tauInDeg,
      meanLongitude: tauInDeg,
      semiMajorAxis: 5.86966e12,
    };
    document.onSlider = (sliderElt, propName, maxValue) => {
      const value = sliderElt.value / 100 * elementMaxes[propName];
      orbitProps[propName] = document.forms.elts[propName].value = value;
      show(orbitProps);
    }
    document.onInput = (inputElt, propName, ma) => {
      orbitProps[propName] = inputElt.value;
      document.forms.elts[propName + '-slider'].value = inputElt.value / elementMaxes[propName] * 100;
      show(orbitProps);
    }
    propsTable.innerHTML = '';
    for (let propName in elementMaxes) {
      const maxValue = elementMaxes[propName];
      const propsTable = document.getElementById('propsTable');
      const value = orbitProps[propName];
      const sliderValue = value / maxValue * 100;
      propsTable.innerHTML +=
        `<tr>
           <td>${propName}:
           <td><input type="range" min="0" max="100" name="${propName}-slider" value="${sliderValue}"
                  oninput="document.onSlider(this, '${propName}')"/>
           <td><input name="${propName}" value="${value}" oninput="document.onInput(this, '${propName}')"/>
         </tr>`;
    }
  }


  let orbit;
  function show(orbitProps) {
    if (orbit) {
      ui.scene.remove(orbit);
    }
    orbit = new Orbit(orbitProps);
    visitFilterProperty(orbit, 'name', 'referencePlane', o => {
        const opts = {
          text: 'Ω Longitude of ascending node',
          color: 'green',
          padding: [-0.5, -0.5]
        };
        o.add(arrow(new THREE.Vector3(1.1, 0, 0), new THREE.Vector3(), 0xff0000, '♈︎Reference direction'));
        o.add(angle(orbit.propsReified.loan, null, opts, opts));
      });
    visitFilterProperty(orbit, 'name', 'orbitalPlane', o => {
        const opts = {
          text: 'ω Argument of periapsis',
          color: 'blue',
          padding: [-0.5, -0.5]
        }
        const lop = orbit.propsReified.lop;
        const radiusOfPeriapsis = line(1, 0, 0, {color: 'blue'});
        radiusOfPeriapsis.rotation.z = lop;
        o.add(radiusOfPeriapsis);
        o.add(angle(lop, null, opts, opts));
        const an = new Label('☊ Ascending node', {fillStyle: 'green'});
        an.position.set(1, 0, 0);
        an.rotation.z = orbit.propsReified.loan;
        o.add(an);
      });
    ui.scene.add(orbit);
  }

  if (location.hash == '#test') {
    // Similar to graphic at https://en.wikipedia.org/wiki/Orbital_elements
    const testOrbit = {
      siderealOrbitPeriod: 0,
      eccentricity: 1,
      inclination: 30,
      longitudeOfAscendingNode: 300,
      longitudeOfPericenter: 110,
      meanLongitude: 0,
      semiMajorAxis: 1,
    }
    setupProps(testOrbit);
    show(testOrbit);
    document.orbit = testOrbit;
  } else {
    planetHelper(p => {
      setupProps(p.props.orbit);
      show(p.props.orbit);
      document.orbit = orbit;
    });
  }
</script>
</body>
</html>
