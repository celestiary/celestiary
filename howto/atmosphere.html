<!DOCTYPE html>
<html>
<head><link rel="stylesheet" href="index.css"/></head>
<body>
<div id="ui"></div>
<h1>Atmosphere</h1>
<p><em>Work in progress.</em>

<p>Using
  <a target="_new"
    href="https://github.com/wwwtyro/glsl-atmosphere">Rye Terrell's
    atmosphere shaders</a> with some physical constants and equation
    corrections adopted from <a href="bruneton-atmos/index.html">my
    attempt to integrate Eric Bruneton's shaders</a>.
    See <a href="https://github.com/celestiary/web/blob/master/howto/atmosphere.html">source</a>
    for extended notes on physical parameters.

<p>Try zooming out (mouse scroll or pad push) to see the change in eye
height.  Currently working on parameterizing the sun position and
camera look direction.

<div id="control"></div>

<script type="module">
  import {PointLight,AxesHelper} from './js/lib/three.js/three.module.js';
  import {GUI} from './js/lib/dat.gui.module.js';

  import ThreeUi from './js/three_ui.js';
  import {box} from './js/shapes.js';

  import Atmosphere from './Atmosphere.js';

  const ui = new ThreeUi('ui');
  ui.camera.position.z = 10;
  const light = new PointLight();
  const dist = 1e7;
  light.position.set(dist, 0, dist);
  ui.scene.add(light);
  ui.scene.add(new AxesHelper(1.1));
  //ui.scene.add(box());

  const gui = new GUI({
    width: 400,
    load: {
      'preset': 'Earth',
      'remembered': {
        'Earth': {
          '0': {
            'SunY': 2,
            // Terrell's original, needs citation.
            'SunIntensity': 22,
            'GroundElevation': 6371000, // meters
            // 'AtmosphereHeight': 100000, // meters
            'AtmosphereHeight': 60000, // meters, Bruneton
            // TODO: these should be based on a constant λ for the frequency of light.
            // The Nvidia reference says Mie is usually λ/4, so maybe λ=84e-6 here?
            //'RayleighRed': 5.5e-6,
            //'RayleighGreen': 13.0e-6,
            //'RayleighBlue': 22.4e-6,
            //'RayleighScaleHeight': 8000,
            // Collienne et al. https://core.ac.uk/download/pdf/18591764.pdf
            // Eq 10: βR = (5.8, 13.5, 33.1)10^6 for wavelengths λ = (680, 550, 440)10−9m
            'RayleighRed': 5.8e-6,
            'RayleighGreen': 13.5e-6,
            'RayleighBlue': 33.1e-6,
            // Rayleigh scale height for Earth
            'RayleighScaleHeight': 8000, // Bruneton agrees
            // https://en.wikipedia.org/wiki/Scale_height#Planetary_examples
            //'RayleighScaleHeight': 7000,
            // https://www.scratchapixel.com/lessons/procedural-generation-virtual-worlds/simulating-sky/simulating-colors-of-the-sky
            //'MieScatteringCoeff': 0.000021,
            'MieScatteringCoeff': 0.000021,
            'MieScaleHeight': 1200, // meters, Bruneton agrees
            // TODO: why positive? Nvidia has it negative.
            // 'MiePolarity': 0.758
            'MiePolarity': 0.8 // Bruneton
          }
        },
        // Values default to Earth values.
        'Mars': {
          '0': {
            'SunY': 2,
            'SunIntensity': 11, // TODO
            //'GroundElevation': 3389500,
            'GroundElevation': 6371000,
            // https://en.wikipedia.org/wiki/Atmosphere_of_Mars#Vertical_structure
            'AtmosphereHeight': 60000,
            // Roughly swap r & b from Earth, then some hand tuning.
            'RayleighRed': 12e-6,
            'RayleighGreen': 6e-6,
            'RayleighBlue': 3e-6,
            // Collienne et al.
            // Eq 11: βR = (19.918, 13.57, 5.75)10−3; λ = (680, 510, 440)10−9m
            //'RayleighRed': 19.918e-3,
            //'RayleighGreen': 13.57e-3,
            //'RayleighBlue': 5.75e-3,
            // https://en.wikipedia.org/wiki/Scale_height#Planetary_examples
            'RayleighScaleHeight': 11100,
            'MieScatteringCoeff': 0.000042, // 2x earth
            'MieScaleHeight': 1200,
            'MiePolarity': 0.8
          }
        },
      },
      'closed': false,
      'folders': {
        'Rayleigh Scattering': {
          'preset': 'Default',
          'closed': false,
          'folders': {}
        },
        'Mie Scattering': {
          'preset': 'Default',
          'closed': false,
          'folders': {}
        }
      }
    },
  });
  const guiElt = gui.domElement;
  guiElt.style.position = 'absolute';
  document.querySelector('#control').appendChild(guiElt);

  // Earth, Terrell's original.
  //const sky = new Atmosphere(0.5, 22, 6371000, 100000,
  //                           5.5e-6, 13.0e-6, 22.4e-6, 8000,
  //                           0.000021, 1200, 0.758);

  // Collienne et al., diffs: Rayleigh and scale height
  const sky = new Atmosphere(2, 22, 6371000, 60000,
                             5.8e-6, 13.5e-6, 33.1e-6, 8000,
                             0.000021, 1200, 0.8);

  gui.add(sky, 'SunY', -1, 5).name('Sun Y');
  gui.add(sky, 'SunIntensity', 0, sky.SunIntensity * 10).name('Sun intensity');
  gui.add(sky, 'GroundElevation', 1, sky.GroundElevation).name('Ground Elevation (m)');
  gui.add(sky, 'AtmosphereHeight', 1, sky.AtmosphereHeight * 2).name('Atmos. height (m)');
  const rls = gui.addFolder('Rayleigh Scattering');
  rls.add(sky, 'RayleighRed', 1e-7, 1e-4).name('Red');
  rls.add(sky, 'RayleighGreen', 1e-7, 1e-4).name('Green');
  rls.add(sky, 'RayleighBlue', 1e-7, 1e-4).name('Blue');
  rls.add(sky, 'RayleighScaleHeight', 1, sky.AtmosphereHeight).name('Scale height (m)');
  rls.open();
  const mie = gui.addFolder('Mie Scattering');
  mie.add(sky, 'MieScatteringCoeff', 0.000001, 0.0001).name('Scattering');
  mie.add(sky, 'MieScaleHeight', 1, sky.AtmosphereHeight).name('Scale height (m)');
  mie.add(sky, 'MiePolarity', -0.999, 0.999).name('Polarity');
  mie.open();
  gui.remember(sky);

  const animation = () => {
    const cameraPosition = ui.camera.position.clone();
    cameraPosition.applyMatrix4(ui.camera.matrixWorld);
    sky.EyeHeight = sky.GroundElevation + cameraPosition.z;
    sky.onRender();
  }
  sky.loadShaders(() => {
    ui.setAnimation(animation);
  });
  ui.scene.add(sky);
</script>
</body>
</html>
