<!DOCTYPE html>
<html>
<head><link rel="stylesheet" href="index.css"/></head>
<body>
<div id="ui"></div>
<h1>Orbit</h1>
An example orbit.  <a href="https://en.wikipedia.org/wiki/Orbital_elements">
  https://en.wikipedia.org/wiki/Orbital_elements</a>
<image style="width: 400px" src="images/Orbit1.png"
       alt="By Lasunncty at the English Wikipedia, CC BY-SA 3.0, https://commons.wikimedia.org/w/index.php?curid=8971052"/>

<form name="elts">
<table>
  <tr>
    <td>Eccentricity:
    <td><input type="range" min="0" max="100" name="ecc-slider" value="0"
               oninput="document.oc(event, document.forms.elts.ecc, 1)"/>
    <td><input name="ecc" value="0"/>
  </tr>
  <tr>
    <td>Longitude of Ascending Node:
    <td><input type="range" min="0" max="100" name="loan-slider" value="0"
               oninput="document.oc(event, document.forms.elts.loan, Math.PI * 2)"/>
    <td><input name="loan" value="0"/>
  <tr>
    <td>Inclination:
    <td><input type="range" min="0" max="100" name="inc-slider" value="0"
               oninput="document.oc(event, document.forms.elts.inc, Math.PI * 2)"/>
    <td><input name="inc" value="0"/>
  </tr>
  <tr>
    <td>Argument of Periapsis:
    <td><input type="range" min="0" max="100" name="aop-slider" value="0"
               oninput="document.oc(event, document.forms.elts.aop, Math.PI * 2)"/>
    <td><input name="aop" value="0"/>
  </tr>
  <tr>
    <td>Tilt:
    <td><input type="range" min="0" max="100" name="tilt-slider" value="0"
               oninput="document.oc(event, document.forms.elts.tilt, Math.PI * 2)"/>
    <td><input name="tilt" value="0"/>
  </tr>
  <tr>
    <td>True Anomaly:
    <td><input type="range" min="0" max="100" name="ta-slider" value="0"
               oninput="document.oc(event, document.forms.elts.ta, Math.PI * 2)"/>
    <td><input name="ta" value="0"/>
  </tr>
</table>
</form>
<script type="module">
  import ThreeUi from './js/three_ui.js';
  import * as THREE from './js/lib/three.module.js';
  import Fullscreen from './js/fullscreen.js';
  import {AmbientLight, PointLight} from './js/lib/three.module.js';
  import {angle, grid, line, solidEllipse} from './js/shapes.js';
  import * as Utils from './js/utils.js';
  import Label from './js/label.js';
  import Scene from './js/scene.js';

  const ui = new ThreeUi('ui');
  ui.camera.position.set(1, 2, 5);
  ui.scene.add(grid({color: 0x0000ff, opacity: 0.3}));
  ui.scene.add(new AmbientLight());

  function addOrbitalGroup(parent, child, orbit) {
    const referencePlane = new THREE.Object3D;
    // Negative rotation since longitude of ascending node wraps
    // around y-axis counter-clockwise.
    referencePlane.rotateX(Math.PI / -2);
    parent.add(referencePlane);
    referencePlane.add(solidEllipse(1, {color: 0xc8c8c8, opacity: 0.5}));

    // Display the Longitude of Ascending Node in the reference plane.
    const lonAscNode = angle(
      orbit.longitudeOfAscendingNode, null,
      {color: 0x42a029},
      ui.container);
    lonAscNode.scale.multiplyScalar(0.3);
    referencePlane.add(lonAscNode);

    const orbitalPlane = solidEllipse();
    orbitalPlane.rotateZ(orbit.longitudeOfAscendingNode);
    referencePlane.add(orbitalPlane);

    const eclipticPlane =
      solidEllipse(orbit.eccentricity, {color: 0xf5f5b9, opacity: 0.5});
    orbitalPlane.add(eclipticPlane);
    eclipticPlane.add(line(null, new THREE.Vector3(1, 0, 0)));

    eclipticPlane.rotateX(orbit.inclination);
    eclipticPlane.rotateZ(orbit.argumentOfPeriapsis + orbit.trueAnomaly);

    const planetGroup = new THREE.Object3D;
    planetGroup.rotateX(Math.PI / 2);
    eclipticPlane.add(planetGroup);

    planetGroup.add(child);

    return referencePlane;
  }

  const form = document.forms.elts;
  let orbitalGroup;
  document.oc = (e, textInputElt, max) => {
    const sliderVal = parseInt(e.srcElement.value);
    const mapVal = sliderVal / 100.0 * max;
    textInputElt.value = mapVal == 0 ? 0 : mapVal.toFixed(3);
    if (orbitalGroup) {
      ui.scene.remove(orbitalGroup);
    }
    const scene = new Scene(ui);
    const earth = scene.newPlanet(Utils.testPlanet('earth'));
    earth.scale.set(0.5, 0.5, 0.5);
    earth.position.set(1, 0, 0);
    orbitalGroup = addOrbitalGroup(ui.scene, earth, {
      eccentricity: parseFloat(form.ecc.value),
      argumentOfPeriapsis: parseFloat(form.aop.value),
      inclination: parseFloat(form.inc.value),
      longitudeOfAscendingNode: parseFloat(form.loan.value),
      tilt: parseFloat(form.tilt.value),
      trueAnomaly: parseFloat(form.ta.value)
    });
  }
</script>
</body>
</html>
